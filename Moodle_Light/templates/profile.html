<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî {{ user.username }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<header>
  <h1><a href="{{ url_for('index') }}" style="color:white;text-decoration:none;">Moodle Light</a></h1>
  <div>
    {% if user %}
      <a href="{{ url_for('profile') }}">üë§ {{ user.username }} ({{ user.role }})</a>
      <form method="post" action="{{ url_for('logout') }}" style="display:inline">
        <button type="submit" class="btn btn-danger" style="margin-left:0.5rem;">–í—ã–π—Ç–∏</button>
      </form>
    {% else %}
      <a href="{{ url_for('login') }}" class="btn btn-accent">–í–æ–π—Ç–∏</a>
    {% endif %}
  </div>
</header>

<div class="container">
  <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
  <p>üë§ <strong>{{ user.username }}</strong> ‚Äî <span class="badge {{ 'badge-teacher' if user.role=='teacher' else 'badge-student' }}">{{ user.role }}</span></p>

  {% if user.role == 'student' %}
    <hr>
    <h3>–ú–æ–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</h3>
    {% if student_rows %}
      <div class="table">
        <div class="tr th">
          <div>–ö—É—Ä—Å</div><div>–ó–∞–¥–∞–Ω–∏–µ</div><div>–§–∞–π–ª</div><div>–û—Ü–µ–Ω–∫–∞</div><div>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
        </div>
        {% for r in student_rows %}
          <div class="tr">
            <div><a href="{{ url_for('course_view', cid=r.course_id) }}">{{ r.course }}</a></div>
            <div><a href="{{ url_for('task_view', cid=r.course_id, tid=r.task_id) }}">{{ r.task }}</a></div>
            <div>
              {% if r.filename %}
                <a href="{{ url_for('static', filename='../uploads/' + r.filename) }}">{{ r.filename }}</a>
              {% else %}-{% endif %}
            </div>
            <div>{% if r.grade is not none %}{{ r.grade }} / 100{% else %}<em>‚Äî</em>{% endif %}</div>
            <div>{{ r.feedback or '‚Äî' }}</div>
          </div>
        {% endfor %}
      </div>
      <p style="margin-top:.5rem">
        <strong>–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞:</strong>
        {% if avg_grade is not none %}{{ avg_grade }} / 100{% else %}<em>–ø–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫</em>{% endif %}
      </p>
    {% else %}
      <p><em>–í—ã –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —Ä–∞–±–æ—Ç—ã.</em></p>
    {% endif %}
  {% endif %}

  {% if user.role == 'teacher' %}
    <hr>
    <h3>–ú–æ–∏ –∫—É—Ä—Å—ã (–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å)</h3>
    {% if teacher_courses %}
      <ul>
        {% for row in teacher_courses %}
          <li>
            <div>
              <strong>{{ row.course.title }}</strong>
              <span class="muted"> ‚Äî –∑–∞–¥–∞–Ω–∏–π: {{ row.tasks_count }}, –æ—Ç–≤–µ—Ç–æ–≤: {{ row.subs_count }}, –Ω–µ –æ—Ü–µ–Ω–µ–Ω–æ: {{ row.pending_count }}</span>
            </div>
            <div>
              <a class="btn" href="{{ url_for('course_view', cid=row.course.id) }}">–û—Ç–∫—Ä—ã—Ç—å –∫—É—Ä—Å</a>
              <a class="btn" href="{{ url_for('task_list', cid=row.course.id) }}">–ó–∞–¥–∞–Ω–∏—è</a>
              <a class="btn" href="{{ url_for('task_add_form', cid=row.course.id) }}">+ –ó–∞–¥–∞–Ω–∏–µ</a>
            </div>
          </li>
        {% endfor %}
      </ul>

      {% set has_pending = teacher_courses | selectattr('pending_count', 'gt', 0) | list %}
      {% if has_pending %}
        <h4 style="margin-top:1rem">–ù–µ–∑–∞—á—Ç—ë–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–ø–µ—Ä–≤—ã–µ 10 –Ω–∞ –∫—É—Ä—Å)</h4>
        <ul>
          {% for row in teacher_courses if row.pending_count > 0 %}
            <li>
              <div>
                <strong>{{ row.course.title }}</strong>
                <ul>
                  {% for s in row.pending %}
                    <li>
                      {{ username(s.user_id) }}
                      ‚Äî <a href="{{ url_for('static', filename='../uploads/' + s.filename) }}">{{ s.filename }}</a>
                      ‚Äî <a href="{{ url_for('grade_form', cid=row.course.id, tid=s.task_id, uid=s.user_id) }}">–û—Ü–µ–Ω–∏—Ç—å</a>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    {% else %}
      <p><em>–ü–æ–∫–∞ —É –≤–∞—Å –Ω–µ—Ç –∫—É—Ä—Å–æ–≤.</em></p>
    {% endif %}
  {% endif %}
</div>

</body>
</html>